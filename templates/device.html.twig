{% extends 'base.html.twig' %}

{% block title %}{{ 'Winback Interface | Device'|trans }}{% endblock %}

{% block content %}
    <div class="d-flex flex-column justify-content-between align-items-center mx-0 px-0 w-100">
            <div class="row w-100 h-100 mt-4">
                <div class="col-md-3">
                    {% include "device/_filter.html.twig" %}
                </div>
                <!-- ===== DEVICE TABLE ===== -->
                <div class="col-md-9 h-100">
                    <h1 class="text-center mb-4">{{ 'Device'|trans }}</h1>
                    {% for message in app.flashes('error') %}
                        <div class="p-3 my-2 rounded-2 alert alert-danger">{{ message }}</div>
                    {% endfor %}
                        <!--
                        <div class="p-3 my-2 rounded-2 alert alert-warning" id="selectedZone"></div>
                        -->
                    {% for message in app.flashes('infoDevice') %}
                        <div class="p-3 my-2 rounded-2 alert alert-success">{{ message }}</div>
                    {% endfor %}
                       
                    <div id="listDevice" class="w-100" style="margin-bottom: 1em;">
                        <div id="listDeviceTable" class="table-responsive w-100 h-100">
                            <table class="table table-striped table-bordered table-hover w-100" id="deviceTable" data-toggle="table" data-pagination="true" data-sort-name="sn" data-search="true" style="height: 100px;">
                                
                                <thead class="w-100 align-middle">
                                    <tr class="h-100 w-100 align-middle" id="deviceTableTitle">
                                        <th scope="col"></th>
                                        <th scope="col" class="h-100 p-0 text-nowrap">
                                            <div class="h-100 d-flex justify-content-between input-group flex-nowrap text-center align-items-center ps-2">
                                                {{ 'Serial Number'|trans }}
                                                <span class="btn btn-light text-dark h-100 p-1" style="border-radius: 0;" type="button"><i class="h-100 fa-solid fa-arrow-up-a-z d-flex align-items-center" id="snSort" onclick=sortTable(1)></i></span>
                                            </div>
                                        
                                        </th>
                                        <th scope="col" class="text-center text-nowrap">{{ 'Device Type'|trans }}</th>
                                        <th scope="col" class="text-center text-nowrap">{{ 'Version'|trans }}</th>
                                        <th scope="col" class="text-center text-nowrap">{{ 'Upload Version'|trans }}</th>
                                        <th scope="col" class="text-center text-nowrap">{{ 'Download status'|trans }}</th>
                                        {% if is_granted("ROLE_GOE") %}
                                        <th scope="col" class="text-center text-nowrap">{{ 'Log files'|trans }}</th>
                                        {% endif %}
                                        <th scope="col" class="text-center text-nowrap">{{ 'Forced'|trans }}</th>
                                        <th scope="col" class="text-center text-nowrap">{{ 'Info'|trans }}</th>
                                        <th scope="col" class="text-center text-nowrap">{{ 'Comment'|trans }}</th>
                                    </tr>
                                    <tr class="w-100 align-bottom">
                                        <th class="text-center">
                                        {% if is_granted("ROLE_SAV") %}
                                                                        
                                            {{ form_start(checkform) }}
                                                <div class="row">
                                                    <div class="col form-field form-inline">
                                                        {{ form_row(checkform.check, {'id' : "checkbox_0"}) }}
                                                    </div>
                                                </div>
                                            {{ form_end(checkform) }}
                                            
                                        {% endif %}

                                        </th>
                                        <th></th>
                                        <th></th>
                                        <th></th>
                                        <th id='test_zone_0'>
                                            {% if is_granted("ROLE_SAV")%}
                                                {{ form_start(versionform) }}
                                                    <div class="input-group d-flex flex-nowrap">
                                                    {{form_row(versionform.versionUpload, {attr: { style: 'border-right-style: none; border-top-right-radius: 0; border-bottom-right-radius: 0; width: 3em;'}})}}
                                                    <button type="submit" class="text-center btn bg-orange btn-outline-orange mb-3" style="width: fit-content"><i class="fa-solid fa-check fa-2xs"></i></button>
                                                    </div>
                                                {{ form_end(versionform) }}
                                            {% endif %}
                                        </th>
                                        <th></th>
                                        <th></th>
                                        <th></th>
                                        <th></th>
                                    </tr>
                                </thead>
                                
                                <tbody class="w-100 overflow-scroll" style="height: 15em">

                                    {% for device in devices %}
                                        <tr scope="row" class="w-100">
                                            <td class="text-center">
                                                <div class="form-field text-center align-middle">
                                                <label class="form-check text-center align-middle">
                                                {% if is_granted("ROLE_SAV")%}
                                                    <input type="checkbox" 
                                                    id="checkbox_{{device.id}}" 
                                                    data-id="{{device.id}}" 
                                                    name="checkbox_item" 
                                                    class="form-check-input device-check" {{ (device.selected)? 'checked': ''}}/>
                                                {% endif %}
                                                </label>
                                                </div>
                                            </td>
                                            <td class="text-center text-nowrap">{{device.sn}}</td>
                                            <td class="text-center">{{device.deviceFamily}}</td>
                                            <td class="text-center">{{device.version}}</td>
                                            <td class="text-center version-upload" id="test_zone_{{device.id}}">{{device.versionUpload}}</td>
                                            {#TODO Progress bar#}
                                            
                                            <td class="text-center">
                                                <div class="progress rounded-2 progress-small">
                                                    <div class="progress-bar viride dark-1" style="width: {{device.download}}%">{{ device.download > 0 ? device.download : '' }}
                                                    </div>
                                                </div>
                                            </td>
                                            {% if is_granted("ROLE_GOE")%}
                                            <td class="text-center">
                                                <a download href="{{ asset('Ressource/logs/' ~ device.deviceFamily ~ '/' ~ device.logFile) }}">
                                                <i class="fa-solid fa-download"></i>
                                                </a>
                                            </td>
                                            {% endif %}
                                            <!-- forced -->
                                            <td class="text-center">
                                                {% if device.forced %}<i class="fa-solid fa-f"></i>{% else %}{% endif %}
                                            </td>
                                            <!--info-->
                                            <td class="text-center">
                                                <a id="info_device_{{device.id}}" href="#" class="info_device btn rounded-1 press modal-trigger bg-orange btn-outline-orange" 
                                                data-bs-target="#modal_info_{{device.id}}"
                                                data-id="{{device.id}}"
                                                data-title="{{device.sn}}"
                                                data-bs-toggle="modal">
                                                <i class="fa-solid fa-circle-info"></i>
                                                </a>
                                            </td>
                                            <td class="">
                                                <div class="input-group d-flex flex-nowrap text-break overflow-hidden comment-form">
                                                    <input class="comment_input border border-0" style="background-color:#f1874144;" type="text" name="nm" value="{{device.comment}}">
                                                    <button class="comment_button btn btn-dark border-0" type="button" name="name" value="" data-id="{{device.id}}"><i class="fa-solid fa-check"></i></button> 
                                                </div> 
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    
                                </tbody>
                            </table>
                            
                        </div>
                    </div>

                    {{ knp_pagination_render(devices) }}
                </div>

                <!-- Button to add device table -->
                {% if is_granted("ROLE_SUPER_ADMIN") %}
                    <button id="floatingBtn" class="btn bg-orange btn-outline-orange  d-flex align-items-center justify-content-center" 
                    style="border: none; border-radius: 50%; height: 4em; width: 4em; box-shadow: 2px 2px 3px #999;" 
                    type="button"
                    data-bs-target="#modal_upload"
                    data-bs-toggle="modal">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                {% endif %}
                <!-- ===== UPLOAD MODALS ===== -->
                {% include 'device/upload_modals.html.twig' %}


            </div>
            <!-- ===== /DEVICE TABLE ===== -->

            <!-- ===== INFO MODALS ===== -->
            
            {% include 'device/info_modals.html.twig' %}
            
            
            {#
            TODO Uncomment new device if needed to test
            <button class="ml-auto btn shadow-1 rounded-1 small bg-orange btn-outline-orange"><a href="{{path('device_add')}}">New Device</a></button>
            #}

            <!-- ===== DEVICE ACTION ===== -->
            {#
            {% include 'device/device_action.html.twig' %}
            #}
            <!--
            <div id="errorDeviceConnect" class="alert alert-danger"></div>
            -->
            <!-- ===== ACCESS MODALS ===== -->
            {#
            {% include 'device/acces_modals.html.twig' %}
            #}
        </div>

    </div>
    

{% endblock %}

{% block javascripts %}

    
    <script type="text/javascript">
    //var path = "{{ asset('js/TCPClient2.php')}}";
    </script>
    
    <script>

    // ######### Sort Table by alphabetical order ######### //
    function sortTable(n) {
        var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
        table = document.getElementById("deviceTable");
        switching = true;
        // Set the sorting direction to ascending:
        dir = "asc";
        while (switching) {
        // Start by saying: no switching is done:
        switching = false;
        rows = table.rows;
        for (i = 2; i < (rows.length -1); i++) {
            // Start by saying there should be no switching:
            shouldSwitch = false;
            x = rows[i].getElementsByTagName("TD")[n];
            y = rows[i + 1].getElementsByTagName("TD")[n];
            if (dir == "asc") {
            if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                // If so, mark as a switch and break the loop:
                shouldSwitch = true;
                break;
            }
            } else if (dir == "desc") {
            if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
                // If so, mark as a switch and break the loop:
                shouldSwitch = true;
                break;
            }
            }
        }
        if (shouldSwitch) {
            rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
            switching = true;
            // Each time a switch is done, increase this count by 1:
            switchcount ++;
        } else {
            if (switchcount == 0 && dir == "asc") {
            dir = "desc";
            switching = true;
            }
        }
        }
    }
    </script>
    <!--
    <script src="https://unpkg.com/bootstrap-table@1.20.2/dist/bootstrap-table.min.js"></script>
    -->
    <!--
    <script type="text/javascript" src="{{ asset('js/winback.js')}}"></script>
    <script type="text/javascript" src="{{ asset('js/socket.js')}}"></script>
    
    <script type="text/javascript" src="{{ asset('js/scripts.js')}}"></script>
    -->
    <script type="text/javascript" src="{{ asset('js/scripts.js')}}"></script>
    <script type="text/javascript" src="{{ asset('js/winback.js')}}"></script>
    
{% endblock %}